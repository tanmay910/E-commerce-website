<%- include('../include/head.ejs')%>
<link rel="stylesheet" href="/css/cart.css">
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>

<%- include('../include/navigation.ejs')%>

<main>
    <ul class="cart__item-list">
        <% products.forEach(p => { %>
            <li class="cart__item">
                <h1><%= p.productId.title %></h1>
                <h2>Quantity: <%= p.quantity %></h2>
            </li>
        <% }) %>
    </ul>
    <div class="centered">
        <h2>Total: â‚¹<%= totalSum %></h2>
        <button class="btn" id="rzp-button1">Pay with Razorpay</button>
    </div>
</main>

<%- include('../include/end.ejs')%>

<script>
    const options = {
        key: "<%= razorpayKeyId %>", // Razorpay Key ID from backend
        amount: "<%= totalSum * 100 %>", // Razorpay accepts amount in paise
        currency: "INR",
        name: "E-commerce Store",
        description: "Test Transaction",
        image: "/your_logo.png", // Add your company logo here
        order_id: "<%= razorpayOrderId %>", // Order ID from Razorpay
        handler: function (response){
            // Handle payment success
            fetch('/razorpay-callback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'CSRF-Token': '<%= csrfToken %>' // Include the CSRF token for security
                },
                body: JSON.stringify({
                    razorpay_payment_id: response.razorpay_payment_id,
                    razorpay_order_id: response.razorpay_order_id,
                    razorpay_signature: response.razorpay_signature
                })
            }).then(function(response) {
                window.location.href = '/orders';
            }).catch(function(error) {
                console.error(error);
            });
        },
        prefill: {
            email: "<%= user.email %>", // User's email
        },
        notes: {
            address: "Your Company Address"
        },
        theme: {
            color: "#3399cc"
        }
    };

    const rzp1 = new Razorpay(options);
    document.getElementById('rzp-button1').onclick = function(e){
        rzp1.open();
        e.preventDefault();
    }
</script>
